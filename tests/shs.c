/* Header files */
/* ------------------------------------------------------------------------- */
#include <config.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#ifdef _MSC_VER
#   define _USE_MATH_DEFINES
#endif
#include <math.h>
#include "../src/prec.h"
/* ------------------------------------------------------------------------- */






/* Function prototypes */
/* ------------------------------------------------------------------------- */
int cmp_arrays(REAL *, REAL *, size_t, REAL);
/* ------------------------------------------------------------------------- */






/* Function to test the "shs" module */
/* ------------------------------------------------------------------------- */
int shs(unsigned long nmax_topo, char SHCs_topo_file[],
        unsigned long nmax_pot, char SHCs_pot_file[])
{
    /* --------------------------------------------------------------------- */
    if (nmax_topo != 4)
    {
        fprintf(stderr, "\"nmax_topo\" has to be \"4\".\n");
        exit(CHARM_FAILURE);
    }


    if (nmax_pot != 10)
    {
        fprintf(stderr, "\"nmax_pot\" has to be \"10\".\n");
        exit(CHARM_FAILURE);
    }
    /* --------------------------------------------------------------------- */






    /* Initialize an error structure to be used throughout the function */
    /* --------------------------------------------------------------------- */
    CHARM(err) *err = CHARM(err_init)();
    if (err == NULL)
    {
        fprintf(stderr, "Failed to initialize an \"err\" structure.\n");
        exit(CHARM_FAILURE);
    }
    /* --------------------------------------------------------------------- */






    /* Read the potential and topo coefficients from text files */
    /* --------------------------------------------------------------------- */
    CHARM(shc) *shcs_topo = CHARM(shc_init)(nmax_topo, ADDP(1.0), ADDP(1.0));
    if (shcs_topo == NULL)
    {
        fprintf(stderr, "Failed to initialize a \"shc\" structure.\n");
        exit(CHARM_FAILURE);
    }
    FILE *fptr = fopen(SHCs_topo_file, "r");
    if (fptr == NULL)
    {
        fprintf(stderr, "Failed to open the stream for \"%s\".\n",
                SHCs_topo_file);
        exit(CHARM_FAILURE);
    }
    CHARM(shc_read_mtx)(fptr, nmax_topo, shcs_topo, err);
    CHARM(err_handler)(err, 1);
    fclose(fptr);


    CHARM(shc) *shcs_pot = CHARM(shc_init)(nmax_pot, ADDP(1.0), ADDP(1.0));
    if (shcs_pot == NULL)
    {
        fprintf(stderr, "Failed to initialize a \"shc\" structure.\n");
        exit(CHARM_FAILURE);
    }
    fptr = fopen(SHCs_pot_file, "r");
    if (fptr == NULL)
    {
        fprintf(stderr, "Failed to open the stream for \"%s\".\n",
                SHCs_pot_file);
        exit(CHARM_FAILURE);
    }
    CHARM(shc_read_mtx)(fptr, nmax_pot, shcs_pot, err);
    CHARM(err_handler)(err, 1);
    fclose(fptr);


    shcs_pot->c[0][0] = ADDP(0.0);
    /* --------------------------------------------------------------------- */






    /* Check a symmetric point grid and the PSLR algorithm*/
    /* --------------------------------------------------------------------- */
    CHARM(crd) *grd;
    REAL *f;


    /* Compute the Gauss--Legendre grid and change it radius, so that it varies
     * with the latitude */
    /* ..................................................................... */
    grd = CHARM(crd_gl)(nmax_topo, shcs_pot->r);
    if (grd == NULL)
    {
        fprintf(stderr, "Failed to initialize the Gauss--Legendre "
                        "grid.\n");
        exit(CHARM_FAILURE);
    }


    for (size_t i = 0; i < grd->nlat; i++)
        grd->r[i] += (REAL)(i) * ADDP(1000.0);
    /* ..................................................................... */


    f = (REAL *)malloc(grd->nlat * grd->nlon * sizeof(REAL));
    if (f == NULL)
    {
        fprintf(stderr, "malloc failure.\n");
        exit(CHARM_FAILURE);
    }


    CHARM(shs_point)(grd, shcs_pot, nmax_pot, f, err);
    CHARM(err_handler)(err, 1);


    int errnum = 0;


    {
    REAL f_gl_ref[50] = {
                             ADDP(-4.9008143993366655908965608539467252e+04),
                             ADDP(-4.9329891256608864527325929115733540e+04),
                             ADDP(-4.9635626836850793781255172869239402e+04),
                             ADDP(-4.9658421115512537639512384315699654e+04),
                             ADDP(-4.9428011879568417587886508713687893e+04),
                             ADDP(-4.9370330451844875383736510685594241e+04),
                             ADDP(-4.9430384219603357428482989714604822e+04),
                             ADDP(-4.9744905739591228565329618232892493e+04),
                             ADDP(-4.9620210128701913155042643523683109e+04),
                             ADDP(-4.8952854401149282703760557487032845e+04),
                             ADDP( 4.7582766955655372062032636022836805e+03),
                             ADDP( 4.5363256710093685206753823390276611e+03),
                             ADDP( 4.0066059847323103299235580072279953e+03),
                             ADDP( 4.0495879672934256908671990520484802e+03),
                             ADDP( 4.6458263138118444666917215642295940e+03),
                             ADDP( 4.2534685611452818663052160330055832e+03),
                             ADDP( 4.0697784740443157072078596663937537e+03),
                             ADDP( 4.1070379471413992232200434595666309e+03),
                             ADDP( 3.9069959492412761543669827909718793e+03),
                             ADDP( 4.6136478009104524613593111673691012e+03),
                             ADDP( 3.4044920570500151889729375711624890e+04),
                             ADDP( 3.3624333752304354425950394809774122e+04),
                             ADDP( 3.2935673621225794860853434169988993e+04),
                             ADDP( 3.4096298933509784804731803453837742e+04),
                             ADDP( 3.4553239343954447308092113036348099e+04),
                             ADDP( 3.4064621249709034431787697135627321e+04),
                             ADDP( 3.3902170276296612731788102457507957e+04),
                             ADDP( 3.3675110227406783320089003250121213e+04),
                             ADDP( 3.3994588588732409789897097163377945e+04),
                             ADDP( 3.3736380128386456094792576955285448e+04),
                             ADDP( 4.5627580342505471253283782397241257e+03),
                             ADDP( 4.6235572401707307989320028579703676e+03),
                             ADDP( 4.4475179596209506573764409576710800e+03),
                             ADDP( 3.9754439983024223452141144093141223e+03),
                             ADDP( 4.4439939980075825606016004698648207e+03),
                             ADDP( 4.6831738338887692215665830932693432e+03),
                             ADDP( 4.2450641955024577541667648644577548e+03),
                             ADDP( 4.2998190913557904321814873729585811e+03),
                             ADDP( 4.5678059749999740036157711080265980e+03),
                             ADDP( 4.2837340185767180830510961061696691e+03),
                             ADDP(-4.9228797458842052467896006572508551e+04),
                             ADDP(-4.9077252118587971664691330236895536e+04),
                             ADDP(-4.9134697976260126918954279368249516e+04),
                             ADDP(-4.9511758325300456154824096789557462e+04),
                             ADDP(-4.9763557866465539682359422793150912e+04),
                             ADDP(-4.9910501246824771315002463719622749e+04),
                             ADDP(-4.9813986634669971955606874667774687e+04),
                             ADDP(-4.9589612041804474993489301808865641e+04),
                             ADDP(-4.9342137518963563500753936241755708e+04),
                             ADDP(-4.9250812865361195364468875100273352e+04)};


    printf("    Solid SHS with point values, a symmetric grid and "
           "the PSLR algorithm...\n");
    errnum += cmp_arrays(f, f_gl_ref, grd->nlat * grd->nlon,
                         CHARM(glob_threshold));
    }


    CHARM(crd_free)(grd);
    free(f);
    /* --------------------------------------------------------------------- */






    /* Check a symmetric point grid and the FFT algorithm*/
    /* --------------------------------------------------------------------- */
    /* Compute the Gauss--Legendre grid and change it radius, so that it varies
     * with the latitude */
    /* ..................................................................... */
    grd = CHARM(crd_gl)(nmax_pot, shcs_pot->r);
    if (grd == NULL)
    {
        fprintf(stderr, "Failed to initialize the Gauss--Legendre "
                        "grid.\n");
        exit(CHARM_FAILURE);
    }


    for (size_t i = 0; i < grd->nlat; i++)
        grd->r[i] += (REAL)(i) * ADDP(1000.0);
    /* ..................................................................... */


    f = (REAL *)malloc(grd->nlat * grd->nlon * sizeof(REAL));
    if (f == NULL)
    {
        fprintf(stderr, "malloc failure.\n");
        exit(CHARM_FAILURE);
    }


    CHARM(shs_point)(grd, shcs_pot, nmax_pot, f, err);
    CHARM(err_handler)(err, 1);


    {
    REAL f_gl_ref[242] = {
                            ADDP(-6.27885681760435901199960982957028942e+04),
                            ADDP(-6.28526835004040149699294385084938052e+04),
                            ADDP(-6.29320479735914725278561101400740191e+04),
                            ADDP(-6.30128906650629644046978595546516265e+04),
                            ADDP(-6.30868868938195818788134295702188078e+04),
                            ADDP(-6.31465251020967817635609469455069688e+04),
                            ADDP(-6.31853198429934783201977556427290850e+04),
                            ADDP(-6.32018105721825871849218373537391937e+04),
                            ADDP(-6.32009901143628929474479726187222496e+04),
                            ADDP(-6.31905589397111567913409359872268405e+04),
                            ADDP(-6.31769140927230815653315296920183757e+04),
                            ADDP(-6.31655746474683056500837572601914249e+04),
                            ADDP(-6.31627309912860257215897850953421106e+04),
                            ADDP(-6.31721027887234664583717307281327190e+04),
                            ADDP(-6.31884387025852892869944583402877621e+04),
                            ADDP(-6.31949168342649896035547991668070822e+04),
                            ADDP(-6.31694324063287062294311082016077966e+04),
                            ADDP(-6.30982232651111623095079291756703573e+04),
                            ADDP(-6.29890283659571998597360401589549856e+04),
                            ADDP(-6.28727737768531580634652104138717259e+04),
                            ADDP(-6.27884643380309914393121112367505633e+04),
                            ADDP(-6.27607618058437226972719538981169751e+04),
                            ADDP(-4.55193156161296733517958310211752813e+04),
                            ADDP(-4.56820607924476382684594144840012998e+04),
                            ADDP(-4.58219783203676982853410477277101160e+04),
                            ADDP(-4.59714660956447557789877907026165208e+04),
                            ADDP(-4.61353691362871194360157618941164261e+04),
                            ADDP(-4.62567878346939880348312615573977465e+04),
                            ADDP(-4.62620985630986652820050810010592047e+04),
                            ADDP(-4.61367698187878230893358611880462112e+04),
                            ADDP(-4.59801885720765917947262705619808272e+04),
                            ADDP(-4.59026733321018381228104386243200891e+04),
                            ADDP(-4.58903848005149309949925436487076622e+04),
                            ADDP(-4.58740605682446723018237178722315952e+04),
                            ADDP(-4.58609660331857528449412579406169522e+04),
                            ADDP(-4.59111557432824604770965776715310449e+04),
                            ADDP(-4.60431176726029700421776697357668979e+04),
                            ADDP(-4.62141710873108717366394212048369527e+04),
                            ADDP(-4.63415377242389336913623641027533944e+04),
                            ADDP(-4.63123443885434535943396802893593437e+04),
                            ADDP(-4.60588555345335570530987968220177711e+04),
                            ADDP(-4.56832496312484387839808762258513495e+04),
                            ADDP(-4.54148388430848802756352825255446454e+04),
                            ADDP(-4.53839115238148328637868671612569999e+04),
                            ADDP(-1.98229352820620229570396891895983905e+04),
                            ADDP(-1.99289644176105579205242482591128344e+04),
                            ADDP(-2.00598864006228107658101052749097859e+04),
                            ADDP(-2.03162171065157297867482309448402695e+04),
                            ADDP(-2.05871852608862451267956023911326338e+04),
                            ADDP(-2.07618727539698166016418307959601430e+04),
                            ADDP(-2.07764833487027062640880211013792559e+04),
                            ADDP(-2.04797440180818435086547355186023736e+04),
                            ADDP(-2.01196346630126662918617851729623136e+04),
                            ADDP(-2.01059987171447641793557486194324371e+04),
                            ADDP(-2.02951455328071480695501565206079937e+04),
                            ADDP(-2.03584701161901310964652393849919370e+04),
                            ADDP(-2.03375526824807003087580640090017588e+04),
                            ADDP(-2.03882420240698032650653135216772491e+04),
                            ADDP(-2.04641154109337393299292278427948452e+04),
                            ADDP(-2.04934860885876985233184382841313669e+04),
                            ADDP(-2.05726514773210504670471377830850031e+04),
                            ADDP(-2.06880446835580499138501487501927076e+04),
                            ADDP(-2.05499113367051280457584122952478444e+04),
                            ADDP(-2.01010332604939267485132465459121924e+04),
                            ADDP(-1.97522065547778680806111887657236212e+04),
                            ADDP(-1.97156347640897641631122097215899449e+04),
                            ADDP( 6.82296867969184632091977346469067709e+03),
                            ADDP( 6.73511481707375332307126005301447313e+03),
                            ADDP( 6.63997636523006148852644396120719077e+03),
                            ADDP( 6.36603546510660219141576061262066795e+03),
                            ADDP( 6.11356864276978837005331535470505022e+03),
                            ADDP( 6.02517404833716154055599274700052686e+03),
                            ADDP( 5.99022772955951162659652853340743840e+03),
                            ADDP( 6.31403026658968735838451502539379565e+03),
                            ADDP( 6.73961404761183734661044517813234390e+03),
                            ADDP( 6.67998337327466615390046064364465830e+03),
                            ADDP( 6.39733300987144989423651158499269562e+03),
                            ADDP( 6.34473430774429566707076355111800928e+03),
                            ADDP( 6.35806643959356680882124123330938201e+03),
                            ADDP( 6.19545564687551698636416017080326764e+03),
                            ADDP( 6.01770158008978163795939449140838257e+03),
                            ADDP( 6.10085196711702363510316267520399392e+03),
                            ADDP( 6.23085507847845531214689995966018492e+03),
                            ADDP( 6.09305315940538467696058842617109474e+03),
                            ADDP( 5.97670127122498224322647843169334112e+03),
                            ADDP( 6.32831335864551607815724610930777725e+03),
                            ADDP( 6.71357126069916477512334352893234155e+03),
                            ADDP( 6.81783769465083821323646570786076502e+03),
                            ADDP( 2.67157278137138531260787792150566278e+04),
                            ADDP( 2.65334563800721444017766230218531969e+04),
                            ADDP( 2.64564989952276257785477109125210529e+04),
                            ADDP( 2.62142857973687101697969183400510603e+04),
                            ADDP( 2.57806086004432060975120205815013839e+04),
                            ADDP( 2.56675758402798770151506126866860791e+04),
                            ADDP( 2.60469862806353203802248143906212220e+04),
                            ADDP( 2.65925317219842063156174479436028262e+04),
                            ADDP( 2.69101944030751115624492019215940399e+04),
                            ADDP( 2.68676547823103290631756523644103492e+04),
                            ADDP( 2.66312158532161043341680170993072885e+04),
                            ADDP( 2.65338318244277523631979558284554351e+04),
                            ADDP( 2.65352428272529491594448372034114501e+04),
                            ADDP( 2.64044612593768126649903004846137709e+04),
                            ADDP( 2.60888403340987131998357618074071556e+04),
                            ADDP( 2.60570883943763939300042134641925199e+04),
                            ADDP( 2.62877915308260820223129973155482931e+04),
                            ADDP( 2.63530667008039958218793796211672653e+04),
                            ADDP( 2.60369738263066542270836226245419552e+04),
                            ADDP( 2.60645797157710079317092762429626684e+04),
                            ADDP( 2.64898427520417227072184175129742891e+04),
                            ADDP( 2.66913908000661129175778005864895932e+04),
                            ADDP( 3.39968671494440792468642825475197057e+04),
                            ADDP( 3.38389469433713703237115730633697443e+04),
                            ADDP( 3.36131322726229053882061217341070353e+04),
                            ADDP( 3.34154016343250698866821433857431009e+04),
                            ADDP( 3.30383598946682859789960504536552528e+04),
                            ADDP( 3.28720163278336348706619789296519094e+04),
                            ADDP( 3.35654664939439708777923395085331868e+04),
                            ADDP( 3.42510128840678450255975680813683206e+04),
                            ADDP( 3.44735571347978556063220416803259409e+04),
                            ADDP( 3.44812129364494959520796508246688437e+04),
                            ADDP( 3.42457630100617271593988682707532208e+04),
                            ADDP( 3.40168491101109236661759435212092729e+04),
                            ADDP( 3.39146808246968698581750724194769835e+04),
                            ADDP( 3.38891257472875632262261003145087248e+04),
                            ADDP( 3.36566326710295185715943472801745971e+04),
                            ADDP( 3.35995135121432064341610134926635997e+04),
                            ADDP( 3.36973829275941793458337652353112601e+04),
                            ADDP( 3.39382978874098764582967697713034932e+04),
                            ADDP( 3.38199824084924101224921671041254896e+04),
                            ADDP( 3.35157675715364964752568473078145297e+04),
                            ADDP( 3.37556260116804590636236065802518932e+04),
                            ADDP( 3.39593062444967789004490741219330014e+04),
                            ADDP( 2.65385469935970153567123669780195974e+04),
                            ADDP( 2.65568527156916823663193400060898558e+04),
                            ADDP( 2.63286254895987438013406389783909774e+04),
                            ADDP( 2.62022050536156470547169336554319796e+04),
                            ADDP( 2.61152932010439396867267390493886851e+04),
                            ADDP( 2.58559800591105518251198599309297314e+04),
                            ADDP( 2.60165275171207533692540159838112988e+04),
                            ADDP( 2.64074463956623371685847399183039553e+04),
                            ADDP( 2.67901148619586564511732006749529612e+04),
                            ADDP( 2.70172590569058763464969295319662419e+04),
                            ADDP( 2.69992720217433349184262813809136867e+04),
                            ADDP( 2.68552362996201125203263429883785985e+04),
                            ADDP( 2.65683861930082613190104117355242135e+04),
                            ADDP( 2.64121407177367854936312019687071586e+04),
                            ADDP( 2.63133010138474874371229068970486538e+04),
                            ADDP( 2.63666966190943379722113874124763343e+04),
                            ADDP( 2.62970851736759932709915830727293095e+04),
                            ADDP( 2.64578997435734637194498772336921693e+04),
                            ADDP( 2.66535300431237375265294958693704145e+04),
                            ADDP( 2.63388861481438408439185840775115945e+04),
                            ADDP( 2.63163351787138021004514604444508306e+04),
                            ADDP( 2.64664148782770899269639043411130282e+04),
                            ADDP( 6.62471163177780813999759479415629833e+03),
                            ADDP( 6.71201739469659920821128210501868215e+03),
                            ADDP( 6.68891960165550216071927286678318428e+03),
                            ADDP( 6.61062596321134317468927587582287706e+03),
                            ADDP( 6.55767735363040663005231344036208389e+03),
                            ADDP( 6.32211838722654028418769698757669662e+03),
                            ADDP( 6.07421272492111905181284758159814750e+03),
                            ADDP( 6.06475898782021881242436113310954665e+03),
                            ADDP( 6.32177429823664079687894416966233395e+03),
                            ADDP( 6.59340098349347686517007343049309057e+03),
                            ADDP( 6.77904431613284594055767804125025310e+03),
                            ADDP( 6.77786688552233968180662502152751413e+03),
                            ADDP( 6.51964511252605092258908267015202027e+03),
                            ADDP( 6.33264473369704033185755753092061770e+03),
                            ADDP( 6.28657290467497470328150647098748205e+03),
                            ADDP( 6.35812405174169667855203634816106503e+03),
                            ADDP( 6.38735994814103993933053291786061669e+03),
                            ADDP( 6.52813544136208909147036179007868412e+03),
                            ADDP( 6.64747535449898713355639580025007125e+03),
                            ADDP( 6.40480482965612657915887120501179584e+03),
                            ADDP( 6.37251053600825615172579610316987720e+03),
                            ADDP( 6.55540612377616086297382342851180104e+03),
                            ADDP(-2.00225456167605302833019751856345239e+04),
                            ADDP(-1.99775451770446662673030586242551425e+04),
                            ADDP(-1.98812139966045572472415252793432280e+04),
                            ADDP(-1.98491914956130495590553138533199877e+04),
                            ADDP(-1.98969554074517716718731798297968640e+04),
                            ADDP(-2.00460324126662640191841723162053169e+04),
                            ADDP(-2.02821051553688740335012251725325663e+04),
                            ADDP(-2.04679909162062994618021376015870491e+04),
                            ADDP(-2.04883437892116952405193508998472725e+04),
                            ADDP(-2.03961297821976955854788222732844239e+04),
                            ADDP(-2.03024464722954085400988124152327042e+04),
                            ADDP(-2.02992282016993377891220721246993579e+04),
                            ADDP(-2.03497025621031276316362004247734337e+04),
                            ADDP(-2.03521302229524358793820585930534045e+04),
                            ADDP(-2.03648734171336983277433559468220044e+04),
                            ADDP(-2.03942887934218307527590782709372611e+04),
                            ADDP(-2.03477038392496740270975526055584412e+04),
                            ADDP(-2.02100175537256069441641712344050888e+04),
                            ADDP(-2.01456127941140290506127043696233694e+04),
                            ADDP(-2.02041491981742901363669288963027741e+04),
                            ADDP(-2.01516338856507573899646229440257320e+04),
                            ADDP(-2.00364331822426470489726912851403299e+04),
                            ADDP(-4.56496362387678980953510596718415211e+04),
                            ADDP(-4.55967603100132397559287370047090503e+04),
                            ADDP(-4.55050146690765432922427952812708486e+04),
                            ADDP(-4.54519010123000629469022162846973763e+04),
                            ADDP(-4.54968819424711074888897276103156935e+04),
                            ADDP(-4.56388673514587935614154363493646719e+04),
                            ADDP(-4.58316105611411304528999299810638048e+04),
                            ADDP(-4.60064112596035753271334426465587929e+04),
                            ADDP(-4.61188488588981051501381090004454631e+04),
                            ADDP(-4.61852773079347491074499163647479226e+04),
                            ADDP(-4.62456807806386990421887786156534786e+04),
                            ADDP(-4.62961904795386873090173055782862170e+04),
                            ADDP(-4.62889444932854526523555719735569329e+04),
                            ADDP(-4.62132119244674208693881391464472531e+04),
                            ADDP(-4.61207163328140102773620585851474110e+04),
                            ADDP(-4.60373938949529911358858359779089584e+04),
                            ADDP(-4.59363109146325521888910710333043293e+04),
                            ADDP(-4.58173226269655234494042759066546729e+04),
                            ADDP(-4.57282701042721195957075744170638996e+04),
                            ADDP(-4.56871291944300000735587846907300615e+04),
                            ADDP(-4.56662599704160423656585075596316340e+04),
                            ADDP(-4.56577095047486170656010937791900142e+04),
                            ADDP(-6.28588277577962723998991139910940233e+04),
                            ADDP(-6.28276745989052617329085563563809646e+04),
                            ADDP(-6.28044903217648350077633575092030433e+04),
                            ADDP(-6.28033681151904608277376095035109199e+04),
                            ADDP(-6.28355290230245380614269106941484264e+04),
                            ADDP(-6.29020726873551753793092657973866368e+04),
                            ADDP(-6.29937509986325940860085877947434625e+04),
                            ADDP(-6.30967366427710212491310489650531318e+04),
                            ADDP(-6.31989477343143876960538521794094256e+04),
                            ADDP(-6.32918351511546036236239964641519680e+04),
                            ADDP(-6.33673318436887340114968735014999492e+04),
                            ADDP(-6.34152877231505384528525008851323682e+04),
                            ADDP(-6.34263715236803641216404151123428104e+04),
                            ADDP(-6.33981486026994711439309380188216330e+04),
                            ADDP(-6.33373005979729920788951730123249350e+04),
                            ADDP(-6.32559821308688272975104904435230518e+04),
                            ADDP(-6.31673029183629033046725499142475964e+04),
                            ADDP(-6.30832430853406398148962915004801803e+04),
                            ADDP(-6.30129049018189255259741852315370394e+04),
                            ADDP(-6.29598621995940714348667350114976425e+04),
                            ADDP(-6.29211724953442573196138202136994052e+04),
                            ADDP(-6.28897191793707326566774062083115945e+04),
                        };

    printf("    Solid SHS with point values, a symmetric grid and "
           "the FFT algorithm...\n");
    errnum += cmp_arrays(f, f_gl_ref, grd->nlat * grd->nlon,
                         CHARM(glob_threshold));
    }


    CHARM(crd_free)(grd);
    free(f);
    /* --------------------------------------------------------------------- */






    /* Check a non-symmetric point grid and the PSLR algorithm*/
    /* --------------------------------------------------------------------- */
    grd = CHARM(crd_dh1)(nmax_topo, shcs_pot->r);
    if (grd == NULL)
    {
        fprintf(stderr, "Failed to initialize the Driscoll--Healy "
                        "grid.\n");
        exit(CHARM_FAILURE);
    }


    for (size_t i = 0; i < grd->nlat; i++)
        grd->r[i] += (REAL)i * ADDP(1000.0);


    f = (REAL *)malloc(grd->nlat * grd->nlon * sizeof(REAL));
    if (f == NULL)
    {
        fprintf(stderr, "malloc failure.\n");
        exit(CHARM_FAILURE);
    }


    CHARM(shs_point)(grd, shcs_pot, nmax_pot, f, err);
    CHARM(err_handler)(err, 1);


    {
    REAL f_dh1_ref[100] = {
                             ADDP(-6.7361214435513443427713062044672123e+04),
                             ADDP(-6.7361214435513443427713062044672123e+04),
                             ADDP(-6.7361214435513443427713062044672123e+04),
                             ADDP(-6.7361214435513443427713062044672123e+04),
                             ADDP(-6.7361214435513443427713062044672123e+04),
                             ADDP(-6.7361214435513443427713062044672123e+04),
                             ADDP(-6.7361214435513443427713062044672123e+04),
                             ADDP(-6.7361214435513443427713062044672123e+04),
                             ADDP(-6.7361214435513443427713062044672123e+04),
                             ADDP(-6.7361214435513443427713062044672123e+04),
                             ADDP(-5.7418067363051062035768698054975315e+04),
                             ADDP(-5.7672343442824736901997676804550778e+04),
                             ADDP(-5.7897098038457881431451557585105483e+04),
                             ADDP(-5.7965861634070767658414166219758781e+04),
                             ADDP(-5.7880725489090760295342820897768043e+04),
                             ADDP(-5.7820215269345598071146103788009516e+04),
                             ADDP(-5.7863862352745733333842771122920875e+04),
                             ADDP(-5.8016205257839587824854972235088745e+04),
                             ADDP(-5.7840498499534158182926409015456665e+04),
                             ADDP(-5.7407773953355122892668473520815103e+04),
                             ADDP(-3.2108879426863682399820058859486187e+04),
                             ADDP(-3.2424463380245900758105004578156314e+04),
                             ADDP(-3.2915912863600430034054714074398493e+04),
                             ADDP(-3.2877825860905064779816154832841830e+04),
                             ADDP(-3.2412251122887717756907251856537905e+04),
                             ADDP(-3.2528290980446267363920931872950188e+04),
                             ADDP(-3.2565716082409289712248030594067297e+04),
                             ADDP(-3.2851177031547463417952412180325821e+04),
                             ADDP(-3.2896141496471444177622912613250551e+04),
                             ADDP(-3.2032391025377658498287311933869816e+04),
                             ADDP(-8.5457983523066814908673511356318882e+02),
                             ADDP(-1.0848337222927446501725819163187547e+03),
                             ADDP(-1.6239414525926187421577209514713484e+03),
                             ADDP(-1.6073145833886137255873973898075548e+03),
                             ADDP(-1.0144538427810655800130288926183582e+03),
                             ADDP(-1.4123838427517640054254474985897359e+03),
                             ADDP(-1.5592824984846447958765596085895696e+03),
                             ADDP(-1.5063064590600565027174674888324391e+03),
                             ADDP(-1.7096834662829826034543097548398137e+03),
                             ADDP(-9.5765217817525345074052504080210573e+02),
                             ADDP( 2.4404682505234960369739566756971820e+04),
                             ADDP( 2.4146825329570939415683456344554502e+04),
                             ADDP( 2.3430906209071123871294159748627605e+04),
                             ADDP( 2.4006942236332074562138085321469484e+04),
                             ADDP( 2.4546978351554254576099021264656347e+04),
                             ADDP( 2.4192300780098092799199675698479162e+04),
                             ADDP( 2.3985292202707128784029131174062369e+04),
                             ADDP( 2.3806602414239332439609184273222340e+04),
                             ADDP( 2.3793062182199557798817558371628365e+04),
                             ADDP( 2.4119607268719621489286875686730605e+04),
                             ADDP( 3.3996867149444079246864282547519706e+04),
                             ADDP( 3.3577125336611872436497117984780368e+04),
                             ADDP( 3.2889911900760446579931627991888212e+04),
                             ADDP( 3.4047357770200863663321314586450924e+04),
                             ADDP( 3.4504196433956775824474300242632497e+04),
                             ADDP( 3.4016849110110923666175943521209273e+04),
                             ADDP( 3.3854074890891236540800264504087805e+04),
                             ADDP( 3.3627599403667177602253141937596170e+04),
                             ADDP( 3.3946040589835363541115125792056200e+04),
                             ADDP( 3.3688934308787881220005246044225497e+04),
                             ADDP( 2.4223007079892384261031288561808395e+04),
                             ADDP( 2.4016481348410981321583704623698522e+04),
                             ADDP( 2.3766702662259060621976887887999806e+04),
                             ADDP( 2.3854072982376970132903162997231953e+04),
                             ADDP( 2.4617331791599821736963492931279886e+04),
                             ADDP( 2.4552623308265878719802829334767298e+04),
                             ADDP( 2.4045075675977785254587284577971333e+04),
                             ADDP( 2.4052822376142776674804308436538411e+04),
                             ADDP( 2.4328309290666807662757113054783779e+04),
                             ADDP( 2.3968675001786250108685532780322776e+04),
                             ADDP(-1.0592637571298570426015443505088804e+03),
                             ADDP(-9.6394472510462544284088217433280814e+02),
                             ADDP(-1.1180946561061535847380836380483587e+03),
                             ADDP(-1.6084206607533424731881291837167007e+03),
                             ADDP(-1.2725522827557409694756195192937560e+03),
                             ADDP(-1.0322568833345923365443043473340616e+03),
                             ADDP(-1.3820430933373534463596462492995331e+03),
                             ADDP(-1.3619247641487964980387253080697260e+03),
                             ADDP(-1.0960801907184907911738358700651128e+03),
                             ADDP(-1.3250112952679647517604758415210611e+03),
                             ADDP(-3.2293286288116354481906087999667512e+04),
                             ADDP(-3.2122921389803654324143599209111238e+04),
                             ADDP(-3.2175001708041476256568085961430908e+04),
                             ADDP(-3.2622068456631140620501645769161339e+04),
                             ADDP(-3.2755389232145313036193667862948856e+04),
                             ADDP(-3.2757333319572785195684075500893599e+04),
                             ADDP(-3.2689785820274873139569835464588422e+04),
                             ADDP(-3.2646106534650248938601739509462024e+04),
                             ADDP(-3.2416704043917730868647544472458369e+04),
                             ADDP(-3.2358427584865756513098862821176238e+04),
                             ADDP(-5.7546730414029652895494226640757818e+04),
                             ADDP(-5.7442231558229094754154119364549497e+04),
                             ADDP(-5.7502329795098673250393287822751528e+04),
                             ADDP(-5.7790102599574299698484149115340307e+04),
                             ADDP(-5.8059479623826468965691921568751842e+04),
                             ADDP(-5.8230622921973332433449084615231583e+04),
                             ADDP(-5.8169902930197533992553102003125405e+04),
                             ADDP(-5.7935171280865818981969937782082580e+04),
                             ADDP(-5.7702063871460464495827634195023925e+04),
                             ADDP(-5.7597235160147493113370694156284150e+04)};


    printf("    SHS with point values, a non-symmetric grid "
           "and the PSLR algorithm...\n");
    errnum += cmp_arrays(f, f_dh1_ref, grd->nlat * grd->nlon,
                         CHARM(glob_threshold));
    }


    CHARM(crd_free)(grd);
    free(f);
    /* --------------------------------------------------------------------- */






    /* Check a non-symmetric point grid and the FFT algorithm*/
    /* --------------------------------------------------------------------- */
    grd = CHARM(crd_dh1)(nmax_pot, shcs_pot->r);
    if (grd == NULL)
    {
        fprintf(stderr, "Failed to initialize the Driscoll--Healy "
                        "grid.\n");
        exit(CHARM_FAILURE);
    }


    for (size_t i = 0; i < grd->nlat; i++)
        grd->r[i] += (REAL)i * ADDP(1000.0);


    f = (REAL *)malloc(grd->nlat * grd->nlon * sizeof(REAL));
    if (f == NULL)
    {
        fprintf(stderr, "malloc failure.\n");
        exit(CHARM_FAILURE);
    }


    CHARM(shs_point)(grd, shcs_pot, nmax_pot, f, err);
    CHARM(err_handler)(err, 1);


    {
    REAL f_dh1_ref[484] = {
                            ADDP(-6.73612144355134434277130620446721228e+04),
                            ADDP(-6.73612144355134434277130620446721228e+04),
                            ADDP(-6.73612144355134434277130620446721228e+04),
                            ADDP(-6.73612144355134434277130620446721228e+04),
                            ADDP(-6.73612144355134434277130620446721228e+04),
                            ADDP(-6.73612144355134434277130620446721228e+04),
                            ADDP(-6.73612144355134434277130620446721228e+04),
                            ADDP(-6.73612144355134434277130620446721228e+04),
                            ADDP(-6.73612144355134434277130620446721228e+04),
                            ADDP(-6.73612144355134434277130620446721228e+04),
                            ADDP(-6.73612144355134434277130620446721228e+04),
                            ADDP(-6.73612144355134434277130620446721228e+04),
                            ADDP(-6.73612144355134434277130620446721228e+04),
                            ADDP(-6.73612144355134434277130620446721228e+04),
                            ADDP(-6.73612144355134434277130620446721228e+04),
                            ADDP(-6.73612144355134434277130620446721228e+04),
                            ADDP(-6.73612144355134434277130620446721228e+04),
                            ADDP(-6.73612144355134434277130620446721228e+04),
                            ADDP(-6.73612144355134434277130620446721228e+04),
                            ADDP(-6.73612144355134434277130620446721228e+04),
                            ADDP(-6.73612144355134434277130620446721228e+04),
                            ADDP(-6.73612144355134434277130620446721228e+04),
                            ADDP(-6.51183564779183524601704966524623550e+04),
                            ADDP(-6.51541976878184134798759210211532320e+04),
                            ADDP(-6.52042120443713993235066345040771957e+04),
                            ADDP(-6.52593316841667385051713732350545668e+04),
                            ADDP(-6.53124670703683567040590949982231883e+04),
                            ADDP(-6.53581860697936556813280572118419620e+04),
                            ADDP(-6.53927491035076079423309089947921255e+04),
                            ADDP(-6.54147567672865104990614479802616882e+04),
                            ADDP(-6.54253302922296423611610976373571731e+04),
                            ADDP(-6.54272779896678926104181432722739508e+04),
                            ADDP(-6.54239917065561542557157913644017286e+04),
                            ADDP(-6.54187977662612088890810662918569624e+04),
                            ADDP(-6.54142648074909427419828069876188530e+04),
                            ADDP(-6.54107213746916100684968097164299029e+04),
                            ADDP(-6.54046719078806473642177302009463962e+04),
                            ADDP(-6.53890213082734835610094374554887229e+04),
                            ADDP(-6.53563049499812630541664367154929402e+04),
                            ADDP(-6.53038779156788116972789074495930898e+04),
                            ADDP(-6.52379050960991419139589047720737722e+04),
                            ADDP(-6.51727703438165518268573815747763187e+04),
                            ADDP(-6.51251934525036689158158640999920811e+04),
                            ADDP(-6.51065080014523002185072217187075070e+04),
                            ADDP(-5.90266269667717868626698065794436464e+04),
                            ADDP(-5.91270562685084613895983354078441723e+04),
                            ADDP(-5.92359091084974693277063006144132450e+04),
                            ADDP(-5.93398699145627177389337709954109736e+04),
                            ADDP(-5.94338495951617704231705175241122127e+04),
                            ADDP(-5.95057944151415211077825961681529160e+04),
                            ADDP(-5.95407852826228777299072845605131502e+04),
                            ADDP(-5.95366092695627156033813069189929464e+04),
                            ADDP(-5.95091425485501720634061929950427463e+04),
                            ADDP(-5.94778101401297445236255170161204847e+04),
                            ADDP(-5.94508237558811105482145524543011269e+04),
                            ADDP(-5.94310477892961216585858785411288664e+04),
                            ADDP(-5.94287678692440191129017632160352839e+04),
                            ADDP(-5.94568610498844157657900252323680423e+04),
                            ADDP(-5.95122667518707378971505987764452158e+04),
                            ADDP(-5.95657383192088699245056875924826694e+04),
                            ADDP(-5.95709962320983733983947729228274180e+04),
                            ADDP(-5.94907395988715550141216813012099740e+04),
                            ADDP(-5.93283586396619315503095631323645354e+04),
                            ADDP(-5.91402010563635439375485317607497047e+04),
                            ADDP(-5.90053593815571579796076150356136671e+04),
                            ADDP(-5.89711583103877402295656368766515105e+04),
                            ADDP(-4.95723074946001345110070767648419906e+04),
                            ADDP(-4.97265464973090016908207226746301550e+04),
                            ADDP(-4.98642239032101120665016773849063688e+04),
                            ADDP(-5.00002087529020941093997499673709908e+04),
                            ADDP(-5.01401718338509695108842970164534843e+04),
                            ADDP(-5.02442183210973428728863616999991978e+04),
                            ADDP(-5.02578560115058504908988021185867334e+04),
                            ADDP(-5.01725713259558830521922366956387387e+04),
                            ADDP(-5.00572737857396421915658222179229029e+04),
                            ADDP(-4.99871605878376427789871330661930043e+04),
                            ADDP(-4.99596189286389586903067231085084820e+04),
                            ADDP(-4.99363912364417024130397558789978094e+04),
                            ADDP(-4.99273274911577033730554506073906670e+04),
                            ADDP(-4.99772282638460422041677214236504038e+04),
                            ADDP(-5.00991516209910913620974447572673138e+04),
                            ADDP(-5.02506717299200088623426918694606326e+04),
                            ADDP(-5.03485772700963572171122462533072763e+04),
                            ADDP(-5.02964418697624094069851857726932345e+04),
                            ADDP(-5.00555941529206888883532541000802392e+04),
                            ADDP(-4.97242227571197455117007309546782826e+04),
                            ADDP(-4.94884693090128180466286290108943737e+04),
                            ADDP(-4.94549104595324534458891333368473130e+04),
                            ADDP(-3.74570573565101736095246575101470761e+04),
                            ADDP(-3.76155782898579222368614113738542478e+04),
                            ADDP(-3.77533091508126042016430730868311261e+04),
                            ADDP(-3.79341503103729404537552261386581695e+04),
                            ADDP(-3.81454576036787503227698461895414385e+04),
                            ADDP(-3.82988199843687452330853725670598492e+04),
                            ADDP(-3.82943770120068937241210715200824985e+04),
                            ADDP(-3.80960201980367689496159884473562749e+04),
                            ADDP(-3.78633571396709549458269612480158199e+04),
                            ADDP(-3.77887973826984289218625354152070868e+04),
                            ADDP(-3.78272674668100690534096118112671380e+04),
                            ADDP(-3.78346914614490361989083142071123229e+04),
                            ADDP(-3.78157581455479604793211270980377375e+04),
                            ADDP(-3.78598728621392259683578511939607063e+04),
                            ADDP(-3.79847331704084803829916692579709817e+04),
                            ADDP(-3.81492061937174700691660426652945928e+04),
                            ADDP(-3.83009839875129777390054469233032971e+04),
                            ADDP(-3.83214837465854175566428638601562394e+04),
                            ADDP(-3.80757920335512098167674233754799437e+04),
                            ADDP(-3.76469867913512375482951494801863703e+04),
                            ADDP(-3.73350340522512325821531229801502748e+04),
                            ADDP(-3.73075198981841137209832556519814466e+04),
                            ADDP(-2.36386830096139227192231464599264151e+04),
                            ADDP(-2.37572673691368195168993786592244271e+04),
                            ADDP(-2.38894334101588500813418653826805884e+04),
                            ADDP(-2.41309274895475900576827265323240482e+04),
                            ADDP(-2.43966921573479049088222842345429044e+04),
                            ADDP(-2.45743099357444507979152212205598228e+04),
                            ADDP(-2.45800832196543063615949820263107859e+04),
                            ADDP(-2.42962825807024786782691545175415281e+04),
                            ADDP(-2.39589564778474949452672951424765938e+04),
                            ADDP(-2.39285207921347656055963358463327965e+04),
                            ADDP(-2.40850610926846104038694187913150638e+04),
                            ADDP(-2.41390271024342663872810602406382642e+04),
                            ADDP(-2.41176288825254633239529742289541623e+04),
                            ADDP(-2.41616565894168369857908467477900414e+04),
                            ADDP(-2.42450896258645697939676161969542563e+04),
                            ADDP(-2.43095805441678993789820810112372808e+04),
                            ADDP(-2.44150488195457553098988922741170925e+04),
                            ADDP(-2.45129716257006340715388325860669040e+04),
                            ADDP(-2.43447795797013864379330415815388953e+04),
                            ADDP(-2.38934056646797320427476945544912049e+04),
                            ADDP(-2.35487734098143183802594609968293628e+04),
                            ADDP(-2.35162799910931091434276453994397994e+04),
                            ADDP(-9.25963102065544996538647808964624551e+03),
                            ADDP(-9.33941304060235641760928232507254347e+03),
                            ADDP(-9.46402043891892630863537337848631357e+03),
                            ADDP(-9.74458596483833673224853481141460591e+03),
                            ADDP(-1.00066457500451442546016947107358691e+04),
                            ADDP(-1.01521330545310356356000879156885821e+04),
                            ADDP(-1.01948782978283886440676819897878069e+04),
                            ADDP(-9.88686153734840368496896034030837380e+03),
                            ADDP(-9.48484536290023349566289188777768429e+03),
                            ADDP(-9.51393740061280995758602919222158773e+03),
                            ADDP(-9.77050612317872040603975222298663295e+03),
                            ADDP(-9.84383563935034274704625648603853365e+03),
                            ADDP(-9.82672352853214321468651767505013064e+03),
                            ADDP(-9.91282650161000236284436830960103562e+03),
                            ADDP(-9.99447003839982846378765574203639752e+03),
                            ADDP(-9.94188675105891995823146469828615999e+03),
                            ADDP(-9.93597496025991051338366522574451811e+03),
                            ADDP(-1.00822476961387023611740023826157768e+04),
                            ADDP(-1.00369768479225703322613750581939691e+04),
                            ADDP(-9.61235964780964986813528512989043301e+03),
                            ADDP(-9.25734831010901634217867844754081440e+03),
                            ADDP(-9.20193344484977221524749283684875159e+03),
                            ADDP( 4.50874897700097490997193458949852215e+03),
                            ADDP( 4.42651241724173942305961094123576994e+03),
                            ADDP( 4.32539252201030088851724968901433585e+03),
                            ADDP( 4.04847573467681128579451215329827281e+03),
                            ADDP( 3.80022064386013306471927330311390409e+03),
                            ADDP( 3.70575171995126598656291387129643627e+03),
                            ADDP( 3.66082079399608784512621221676969396e+03),
                            ADDP( 3.97753138667239170479248580677869524e+03),
                            ADDP( 4.40208508096214735281435650687364538e+03),
                            ADDP( 4.34383418337879033688673193192305390e+03),
                            ADDP( 4.05993183162083974709238846816483491e+03),
                            ADDP( 4.00331319870702541639595080865862598e+03),
                            ADDP( 4.01660723691199138079715352050628620e+03),
                            ADDP( 3.86420208374507716766136922143016018e+03),
                            ADDP( 3.70586625863869648111379573566787756e+03),
                            ADDP( 3.79256197980284565250452200757563029e+03),
                            ADDP( 3.90594771909625564438347787920558994e+03),
                            ADDP( 3.76186554602205026513395762303955274e+03),
                            ADDP( 3.67091351849141681192098736172021014e+03),
                            ADDP( 4.03681489426233737015723221153405255e+03),
                            ADDP( 4.41468318654999589624372299104676259e+03),
                            ADDP( 4.51035462467850541375126568481141286e+03),
                            ADDP( 1.65761772395397966829177686901772352e+04),
                            ADDP( 1.64498696857859870671240421945306249e+04),
                            ADDP( 1.63793048381093587290064183777896437e+04),
                            ADDP( 1.61242584596358386802877201338632268e+04),
                            ADDP( 1.58166550486526491438514049693910601e+04),
                            ADDP( 1.57346408215251673152261830364212769e+04),
                            ADDP( 1.58160886449192410935643646623342337e+04),
                            ADDP( 1.62037430606154788086727194292616851e+04),
                            ADDP( 1.66040324089705248007535647028145508e+04),
                            ADDP( 1.65516529212069189389354740520592745e+04),
                            ADDP( 1.62950692576193063997387956871148989e+04),
                            ADDP( 1.62472471978429125173659855365404823e+04),
                            ADDP( 1.62587552385653915815503435379613617e+04),
                            ADDP( 1.60776752822341746574203588598268918e+04),
                            ADDP( 1.58168532920896714405676447009103925e+04),
                            ADDP( 1.58548964707082382505806234464419871e+04),
                            ADDP( 1.60444396608209707284583812067050334e+04),
                            ADDP( 1.59694138540156376159769824447721922e+04),
                            ADDP( 1.57453072418637182795509346660292884e+04),
                            ADDP( 1.59910826829263860605607282541436619e+04),
                            ADDP( 1.64058408247473389162122061739192837e+04),
                            ADDP( 1.65540432594012278840210099872856534e+04),
                            ADDP( 2.59745802670207573446743686978538740e+04),
                            ADDP( 2.57966946051264142026349547800215131e+04),
                            ADDP( 2.57225194012313791055994245590802713e+04),
                            ADDP( 2.54800184715628670022540251909985558e+04),
                            ADDP( 2.50571283794719341523469106357017964e+04),
                            ADDP( 2.49476132960470595025518572934200045e+04),
                            ADDP( 2.52986085920592617006180557135836374e+04),
                            ADDP( 2.58287274566731597867797333947871275e+04),
                            ADDP( 2.61538328851581677776537643464490642e+04),
                            ADDP( 2.61112743632927338868068976550674243e+04),
                            ADDP( 2.58755739722398923347218396239550896e+04),
                            ADDP( 2.57845584347753519046069323627978435e+04),
                            ADDP( 2.57871834403994120969425617094619967e+04),
                            ADDP( 2.56500127777646224735869398253432554e+04),
                            ADDP( 2.53369074475315717965036213485062290e+04),
                            ADDP( 2.53098766789019866660251086447468097e+04),
                            ADDP( 2.55384599712313994820733345358482785e+04),
                            ADDP( 2.55907954299679630544160812808381300e+04),
                            ADDP( 2.52798106233878236543067764303432386e+04),
                            ADDP( 2.53273339591054510640333072834036536e+04),
                            ADDP( 2.57525938257950373156340606814692348e+04),
                            ADDP( 2.59502933323090272173788805708283900e+04),
                            ADDP( 3.19168014831058761641287327884879463e+04),
                            ADDP( 3.17208292490145319399754724889843724e+04),
                            ADDP( 3.15834783400098634090073833814187570e+04),
                            ADDP( 3.13533767188142816493137886731297779e+04),
                            ADDP( 3.08823164192054682394416453338917823e+04),
                            ADDP( 3.07428626782468107258770840477207165e+04),
                            ADDP( 3.13651372632460328632854049084092133e+04),
                            ADDP( 3.20255736744730175286777574750476834e+04),
                            ADDP( 3.22651905512488012965908116963913429e+04),
                            ADDP( 3.22297145412800743976607890797909739e+04),
                            ADDP( 3.19859798400095010402108002893335887e+04),
                            ADDP( 3.18140195702497553003372073143882712e+04),
                            ADDP( 3.17835309729543952462238162908808238e+04),
                            ADDP( 3.17239658962194893658953909839004850e+04),
                            ADDP( 3.14303095542274324045195133939273948e+04),
                            ADDP( 3.13681720207938237558373052324221627e+04),
                            ADDP( 3.15704211832523571410394762863047241e+04),
                            ADDP( 3.17515233106527813256068961670969463e+04),
                            ADDP( 3.14705894737236074751476771496292515e+04),
                            ADDP( 3.13037653623527107339350232932448624e+04),
                            ADDP( 3.16707329985320843757720931011201084e+04),
                            ADDP( 3.18906850574181429322506398640686816e+04),
                            ADDP( 3.39010319471874058603841504460671738e+04),
                            ADDP( 3.37438964019266840034833855592562744e+04),
                            ADDP( 3.35189382725906406763274562141138813e+04),
                            ADDP( 3.33214176361711860950076476437843854e+04),
                            ADDP( 3.29461111885519594178885604759555620e+04),
                            ADDP( 3.27810322263682454753148777919736306e+04),
                            ADDP( 3.34702851008407855693969684900192375e+04),
                            ADDP( 3.41528742388296316212241605230761732e+04),
                            ADDP( 3.43756201651159001287910443662166366e+04),
                            ADDP( 3.43835741388702537826171652641199414e+04),
                            ADDP( 3.41495046185623183606642026031281864e+04),
                            ADDP( 3.39215707221518328082934484993735813e+04),
                            ADDP( 3.38194423169159659236556871610439805e+04),
                            ADDP( 3.37930976961231163112110898255686060e+04),
                            ADDP( 3.35618115510650317443793190961390428e+04),
                            ADDP( 3.35048756700010774758274663957724996e+04),
                            ADDP( 3.36024354264333283112949083600336638e+04),
                            ADDP( 3.38416776068938368190764730067445379e+04),
                            ADDP( 3.37241152536162160567479749309801534e+04),
                            ADDP( 3.34223037836981041485701894280437317e+04),
                            ADDP( 3.36606133421734347923599745742672644e+04),
                            ADDP( 3.38635890620190183012643427802514209e+04),
                            ADDP( 3.17845288503307840767257835869470687e+04),
                            ADDP( 3.17145284148640780207223681341274737e+04),
                            ADDP( 3.14491754465593472921200594768930546e+04),
                            ADDP( 3.12950394291946913556131789586994694e+04),
                            ADDP( 3.10915105608799489367435199224693881e+04),
                            ADDP( 3.08822960477123673784500679367793393e+04),
                            ADDP( 3.13608980149676630817126600124965441e+04),
                            ADDP( 3.19314831857059706464387299252516130e+04),
                            ADDP( 3.22314279600041993711016357715658577e+04),
                            ADDP( 3.23446172474182131052062352388649447e+04),
                            ADDP( 3.21938127376016918304633920668262000e+04),
                            ADDP( 3.19817880399391318828112019698130937e+04),
                            ADDP( 3.17782853555661876239883323481409534e+04),
                            ADDP( 3.17033693546120371097654471959471620e+04),
                            ADDP( 3.15454034219667238649988667448147092e+04),
                            ADDP( 3.15349109792625016246814678600826522e+04),
                            ADDP( 3.15114782314552348936760690475853498e+04),
                            ADDP( 3.17230743886721165634986044913669232e+04),
                            ADDP( 3.18086088674019251709311267511096174e+04),
                            ADDP( 3.14772381729349913502414651182083527e+04),
                            ADDP( 3.15619645099200196275812309537134806e+04),
                            ADDP( 3.17287486963376267326139098534212469e+04),
                            ADDP( 2.57722708348554271954500566755806603e+04),
                            ADDP( 2.57974322384879976312007334737144402e+04),
                            ADDP( 2.55779636885923125263218195605066100e+04),
                            ADDP( 2.54535321333015261937099986207636061e+04),
                            ADDP( 2.53730335601946655415821193916144124e+04),
                            ADDP( 2.51121477814352602001879971560159468e+04),
                            ADDP( 2.52414017341242301727839774432070069e+04),
                            ADDP( 2.56110675785926269056739825292523499e+04),
                            ADDP( 2.59965130199310231015124274249764876e+04),
                            ADDP( 2.62318728338087175433202265322994385e+04),
                            ADDP( 2.62280200288372851374591573202750714e+04),
                            ADDP( 2.60923979851093263571086290312890943e+04),
                            ADDP( 2.58015776204341546677438989079443599e+04),
                            ADDP( 2.56383900758788963347744282729993557e+04),
                            ADDP( 2.55448097018774923571735102649510380e+04),
                            ADDP( 2.56031369294012627138517240284381936e+04),
                            ADDP( 2.55351195741129191112570671201434783e+04),
                            ADDP( 2.56910396062940485456167358079684546e+04),
                            ADDP( 2.58888530233259329612143740445424786e+04),
                            ADDP( 2.55792465385458793026971971749972635e+04),
                            ADDP( 2.55497877989937209034152043859615606e+04),
                            ADDP( 2.56990868844236219477719599119650273e+04),
                            ADDP( 1.63618739814447391244963954907844718e+04),
                            ADDP( 1.64434491586959531814663186763673991e+04),
                            ADDP( 1.63296367548215540366290215041651050e+04),
                            ADDP( 1.62243249399249256285438765749651942e+04),
                            ADDP( 1.61765686911713353747040089397265415e+04),
                            ADDP( 1.59059095762207780555949865156312940e+04),
                            ADDP( 1.57597439751602410086419652679527140e+04),
                            ADDP( 1.59076217136131753058121796644195982e+04),
                            ADDP( 1.62723701302686773165086066194112562e+04),
                            ADDP( 1.65664694946592532887536186642450337e+04),
                            ADDP( 1.66983116763999484514715087501616278e+04),
                            ADDP( 1.66490904439893949615514258312146995e+04),
                            ADDP( 1.63405331709391267818601457114291712e+04),
                            ADDP( 1.61298004086547543371790437235133038e+04),
                            ADDP( 1.60746439147314237173459156708779181e+04),
                            ADDP( 1.61696858595483533004954841122574500e+04),
                            ADDP( 1.61474799272219189286539177433912975e+04),
                            ADDP( 1.62804085330465368229814179245820821e+04),
                            ADDP( 1.64600588765813140688667897057673933e+04),
                            ADDP( 1.61798031281199762175855646441390689e+04),
                            ADDP( 1.61180974290002888931270830314591077e+04),
                            ADDP( 1.62827552712674666023414421037914820e+04),
                            ADDP( 4.30153487685868227222140787622490078e+03),
                            ADDP( 4.38513869804657188766079052375906724e+03),
                            ADDP( 4.37920251446232222379820179194074614e+03),
                            ADDP( 4.30978571992025907039869417116338267e+03),
                            ADDP( 4.25509277996538845098163479596589116e+03),
                            ADDP( 4.03198056181390482093244912599298856e+03),
                            ADDP( 3.77809086490811739770714871351073203e+03),
                            ADDP( 3.74108789058075321492875097437425575e+03),
                            ADDP( 3.96673948388159877868694726794902512e+03),
                            ADDP( 4.22452084456705284346947386548158885e+03),
                            ADDP( 4.41134753030734425741097729620246434e+03),
                            ADDP( 4.41601569109191942882174826564354013e+03),
                            ADDP( 4.17732039427317289135824886219457372e+03),
                            ADDP( 4.00388981510968104458574587642314322e+03),
                            ADDP( 3.95836814029927659636305671644986325e+03),
                            ADDP( 4.01809585282550994332045886810833765e+03),
                            ADDP( 4.05524343470514589507249768310978694e+03),
                            ADDP( 4.19754999026020627740160160408913828e+03),
                            ADDP( 4.30312664285414207021714128932153511e+03),
                            ADDP( 4.07545484347887347616846647399596568e+03),
                            ADDP( 4.05362166871113557150542991429350292e+03),
                            ADDP( 4.23616842353159439763451245813161586e+03),
                            ADDP(-9.44580878319560754608661108130641704e+03),
                            ADDP(-9.38758875319027455217210740587374468e+03),
                            ADDP(-9.32051647452535620741984681647255729e+03),
                            ADDP(-9.33068722008382467690544330612752415e+03),
                            ADDP(-9.38437720623032558749293288508635607e+03),
                            ADDP(-9.55107098796700509895434414366751197e+03),
                            ADDP(-9.80294155665521539111301230510002826e+03),
                            ADDP(-9.95261383714130306594661634705442192e+03),
                            ADDP(-9.88948354032994237347791352316742371e+03),
                            ADDP(-9.72453837874499669250462525696077296e+03),
                            ADDP(-9.57228755416037456188650041140553504e+03),
                            ADDP(-9.55679558569981721882405965867084228e+03),
                            ADDP(-9.68042099049434417160276151120995876e+03),
                            ADDP(-9.75667676725458011629338922771287449e+03),
                            ADDP(-9.79408862923526125331315999263361524e+03),
                            ADDP(-9.80247823230512664784504757007746621e+03),
                            ADDP(-9.75129344775763094104165300544331974e+03),
                            ADDP(-9.60513665763977938052181578777579357e+03),
                            ADDP(-9.54179432093418903550853857175662092e+03),
                            ADDP(-9.67562182878201070226871350661600003e+03),
                            ADDP(-9.64184325268839554804330594959297267e+03),
                            ADDP(-9.48164750739792446475007384263784459e+03),
                            ADDP(-2.37666986201154214348325141805241482e+04),
                            ADDP(-2.37235691290522197420598917905424998e+04),
                            ADDP(-2.36226703099197865224068047810208685e+04),
                            ADDP(-2.35796325260865025466990088418019452e+04),
                            ADDP(-2.36258535715025545865603171422330441e+04),
                            ADDP(-2.37729960172871142722151229627651026e+04),
                            ADDP(-2.40020944526149715057558999636844620e+04),
                            ADDP(-2.41910767575292344410826881918943381e+04),
                            ADDP(-2.42321398879283117916167434813925982e+04),
                            ADDP(-2.41659508615674588737441978573064797e+04),
                            ADDP(-2.40973663195362562652356014349199245e+04),
                            ADDP(-2.41012374107811988599985941935839495e+04),
                            ADDP(-2.41315987002464923665647356335492649e+04),
                            ADDP(-2.41123124294885782046158507991746165e+04),
                            ADDP(-2.41110962701008559069234812577504820e+04),
                            ADDP(-2.41356176904047261052451258967832181e+04),
                            ADDP(-2.40883069309305650243474889274239869e+04),
                            ADDP(-2.39563130106698513438833066823171116e+04),
                            ADDP(-2.38882094725443142696241294403518361e+04),
                            ADDP(-2.39214850603090628809969201593945385e+04),
                            ADDP(-2.38694400313677546899986866440610412e+04),
                            ADDP(-2.37752836736313370933256955113478475e+04),
                            ADDP(-3.74932617416725220279924325257869666e+04),
                            ADDP(-3.74454704673402885820331353150107925e+04),
                            ADDP(-3.73423992131605730050774743189017551e+04),
                            ADDP(-3.72819073650275552098674173269942564e+04),
                            ADDP(-3.73267397888991952571564890926304406e+04),
                            ADDP(-3.74755169582947960086712146444631628e+04),
                            ADDP(-3.76856653539632914022494022453650780e+04),
                            ADDP(-3.78704677787401416580405344622985063e+04),
                            ADDP(-3.79616231364285156408843296361209312e+04),
                            ADDP(-3.79817996550449198200681505088004182e+04),
                            ADDP(-3.79996359921950352432861641952990275e+04),
                            ADDP(-3.80334048668392123037578329862023215e+04),
                            ADDP(-3.80265131986135991940846749310322471e+04),
                            ADDP(-3.79571170297162015966021886642465339e+04),
                            ADDP(-3.78950503915502325653923907357680649e+04),
                            ADDP(-3.78599933717757514072902368333064777e+04),
                            ADDP(-3.77867503907152895642532945431499049e+04),
                            ADDP(-3.76668909413301247310249827988540242e+04),
                            ADDP(-3.75827234204160369928164157380996720e+04),
                            ADDP(-3.75564766099712315168352814889107783e+04),
                            ADDP(-3.75234133810264099100190817432522918e+04),
                            ADDP(-3.74947309645604779690211746763190828e+04),
                            ADDP(-4.95134094569553459603597266419262611e+04),
                            ADDP(-4.94604462069468675261021720057344660e+04),
                            ADDP(-4.93807156208791275355206452655385421e+04),
                            ADDP(-4.93373828585691964870407436290422087e+04),
                            ADDP(-4.93812765773395494434061733329019377e+04),
                            ADDP(-4.95122322302750984365069757159645392e+04),
                            ADDP(-4.96887188091890486702546383707556413e+04),
                            ADDP(-4.98541005900824194944514446284203874e+04),
                            ADDP(-4.99745737994111465345162566570564867e+04),
                            ADDP(-5.00607692915407004546496067026663578e+04),
                            ADDP(-5.01369231258241925103766561841013539e+04),
                            ADDP(-5.01928110396972153568796946810566287e+04),
                            ADDP(-5.01894582227436692017721886965351908e+04),
                            ADDP(-5.01187580748315248590348708744520491e+04),
                            ADDP(-5.00193539804863540487717112549634031e+04),
                            ADDP(-4.99174661006362280353899239958779403e+04),
                            ADDP(-4.98050954270517369886214327961834067e+04),
                            ADDP(-4.96879207164951513504862695249435084e+04),
                            ADDP(-4.95994556065596371322442836392004605e+04),
                            ADDP(-4.95541322118886569428391878746746810e+04),
                            ADDP(-4.95350623170625494972636548591501751e+04),
                            ADDP(-4.95280236225392985797264780654800987e+04),
                            ADDP(-5.88787424007763132085623856513597534e+04),
                            ADDP(-5.88365780217289207972567795278678642e+04),
                            ADDP(-5.87945220537868846725810648305403036e+04),
                            ADDP(-5.87806389799603919652636704969193830e+04),
                            ADDP(-5.88178880455114739176553871681703072e+04),
                            ADDP(-5.89076622637649356077990111042350604e+04),
                            ADDP(-5.90308471841944443650613709349939909e+04),
                            ADDP(-5.91617714887962297635558984753274654e+04),
                            ADDP(-5.92831577535712237597571205739480975e+04),
                            ADDP(-5.93898757134587700931415903983309112e+04),
                            ADDP(-5.94782840358167355300100160844405094e+04),
                            ADDP(-5.95352175237683631668598526471929231e+04),
                            ADDP(-5.95435254808940030095506005366869246e+04),
                            ADDP(-5.94988599777916427009188097752023474e+04),
                            ADDP(-5.94145853990966506504458543681293628e+04),
                            ADDP(-5.93094679962535759464229904823594590e+04),
                            ADDP(-5.91984925039360702629765694374230681e+04),
                            ADDP(-5.90957891303965815779485811842153467e+04),
                            ADDP(-5.90152012455271726480094881221951068e+04),
                            ADDP(-5.89624438143387367121696280697260444e+04),
                            ADDP(-5.89312831189424282070701660193596069e+04),
                            ADDP(-5.89082243117952519003432115658702263e+04),
                            ADDP(-6.48810680114846158534308884515557216e+04),
                            ADDP(-6.48611113364978575404118133202164677e+04),
                            ADDP(-6.48512729127580164547886066703360863e+04),
                            ADDP(-6.48572548590830758266550113721130412e+04),
                            ADDP(-6.48833054070821643356059769412110098e+04),
                            ADDP(-6.49296517570902021865590254953387135e+04),
                            ADDP(-6.49920874569958053644791457861748062e+04),
                            ADDP(-6.50635960716401611324089899285113870e+04),
                            ADDP(-6.51364500924526124771627234460875396e+04),
                            ADDP(-6.52032966487106386407001895514778289e+04),
                            ADDP(-6.52571452077965541888455084931078411e+04),
                            ADDP(-6.52915069072571482111852712105018829e+04),
                            ADDP(-6.53016855059155587634447182658271712e+04),
                            ADDP(-6.52865841019350344153710090761927833e+04),
                            ADDP(-6.52494249438742400454070395279900334e+04),
                            ADDP(-6.51967419035467132433185569819359390e+04),
                            ADDP(-6.51364886348205716202503621280723633e+04),
                            ADDP(-6.50762365364417322975735752839381013e+04),
                            ADDP(-6.50216964033537516843954827567119480e+04),
                            ADDP(-6.49756929262688797539064974614528095e+04),
                            ADDP(-6.49380990512135598886395791353316336e+04),
                            ADDP(-6.49070505792760074283600919207273008e+04)
                          };


    printf("    SHS with point values, a non-symmetric grid "
           "and the FFT algorithm...\n");
    errnum += cmp_arrays(f, f_dh1_ref, grd->nlat * grd->nlon,
                         CHARM(glob_threshold));
    }


    CHARM(crd_free)(grd);
    free(f);
    /* --------------------------------------------------------------------- */






    /* Check the scatter points */
    /* --------------------------------------------------------------------- */
    CHARM(crd) *sctr = CHARM(crd_init)(CHARM_CRD_POINTS_SCATTERED, 3, 3);
    if (sctr == NULL)
    {
        fprintf(stderr, "Failed to initialize scattered points.\n");
        exit(CHARM_FAILURE);
    }


    if (sctr->nlat != sctr->nlon)
    {
        fprintf(stderr, "Scattered points structure must have the same "
                        "number of latitudes and longitudes.\n");
        exit(CHARM_FAILURE);
    }


    f = (REAL *)malloc(sctr->nlat * sizeof(REAL));
    if (f == NULL)
    {
        fprintf(stderr, "malloc failure.\n");
        exit(CHARM_FAILURE);
    }


    /* Define scattered points (more or less randomly) */
    sctr->lat[0] = ADDP(0.323413435);
    sctr->lat[1] = ADDP(-0.125742);
    sctr->lat[2] = PI_2;
    sctr->lon[0] = ADDP(0.9454322);
    sctr->lon[1] = ADDP(3.02349863);
    sctr->lon[2] = ADDP(2.0) * PI;
    sctr->r[0]   = shcs_pot->r;
    sctr->r[1]   = shcs_pot->r + ADDP(1000.0);
    sctr->r[2]   = shcs_pot->r + ADDP(2000.0);


    CHARM(shs_point)(sctr, shcs_pot, nmax_pot, f, err);
    CHARM(err_handler)(err, 1);


    REAL f_sctr_pnt_ref[3] = {
                             ADDP( 2.3279106133244245769172635820426129e+04),
                             ADDP( 3.2688997791811633386808096536733736e+04),
                             ADDP(-6.7298083247872693116045819003190589e+04)};


    printf("    SHS with point scattered data...\n");
    errnum += cmp_arrays(f, f_sctr_pnt_ref, sctr->nlat,
                         CHARM(glob_threshold));


    CHARM(crd_free)(sctr);
    free(f);
    /* --------------------------------------------------------------------- */






    /* Check the scatter cells */
    /* --------------------------------------------------------------------- */
    sctr = CHARM(crd_init)(CHARM_CRD_CELLS_SCATTERED, 3, 3);
    if (sctr == NULL)
    {
        fprintf(stderr, "Failed to initialize scattered cells.\n");
        exit(CHARM_FAILURE);
    }


    if (sctr->nlat != sctr->nlon)
    {
        fprintf(stderr, "Scattered points structure must have the same "
                        "number of latitudes and longitudes.\n");
        exit(CHARM_FAILURE);
    }


    f = (REAL *)malloc(sctr->nlat * sizeof(REAL));
    if (f == NULL)
    {
        fprintf(stderr, "malloc failure.\n");
        exit(CHARM_FAILURE);
    }


    /* Define more or less randomly selected scattered cells */
    sctr->lat[0] = ADDP(0.323413435);
    sctr->lat[1] = sctr->lat[0] + ADDP(0.234323);
    sctr->lat[2] = ADDP(-0.90234320952);
    sctr->lat[3] = sctr->lat[2] + ADDP(0.4456);
    sctr->lat[4] = ADDP(0.0);
    sctr->lat[5] = sctr->lat[4] + PI_2;
    sctr->lon[0] = ADDP(0.123456789);
    sctr->lon[1] = sctr->lon[0] + ADDP(1.3235);
    sctr->lon[2] = ADDP(4.3445234);
    sctr->lon[3] = sctr->lon[2] + ADDP(0.01);
    sctr->lon[4] = ADDP(0.0);
    sctr->lon[5] = sctr->lon[4] + ADDP(2.0) * PI;
    sctr->r[0]   = shcs_pot->r;
    sctr->r[1]   = shcs_pot->r + ADDP(1000.0);
    sctr->r[2]   = shcs_pot->r + ADDP(2000.0);


    CHARM(shs_cell)(sctr, shcs_pot, nmax_pot, f, err);
    CHARM(err_handler)(err, 1);


    REAL f_sctr_cell_ref[3] = {
                             ADDP( 1.5135625983873617486210727061202668e+04),
                             ADDP(-5.4322056544457148858051059250270673e+03),
                             ADDP(-1.9526364895055449742951543457052676e+01)};


    printf("    SHS with cell scattered data...\n");
#if defined(CHARM_FLOAT)
    errnum += cmp_arrays(f, f_sctr_cell_ref, sctr->nlat,
                         ADDP(10.0) * CHARM(glob_threshold));
#else
    errnum += cmp_arrays(f, f_sctr_cell_ref, sctr->nlat,
                         CHARM(glob_threshold));
#endif


    CHARM(crd_free)(sctr);
    free(f);
    /* --------------------------------------------------------------------- */






    /* Check symmetric grid cells */
    /* --------------------------------------------------------------------- */
    grd = CHARM(crd_init)(CHARM_CRD_CELLS_GRID, 4, 5);
    if (grd == NULL)
    {
        fprintf(stderr, "Failed to initialize grid cells.\n");
        exit(CHARM_FAILURE);
    }


    f = (REAL *)malloc(grd->nlat * grd->nlon * sizeof(REAL));
    if (f == NULL)
    {
        fprintf(stderr, "malloc failure.\n");
        exit(CHARM_FAILURE);
    }


    /* Define symmetric grid cells */
    grd->lat[0] = ADDP(-0.2);
    grd->lat[1] = ADDP(-0.1);
    grd->lat[2] = ADDP(-0.1);
    grd->lat[3] = ADDP(0.0);
    grd->lat[4] = ADDP(0.0);
    grd->lat[5] = ADDP(0.1);
    grd->lat[6] = ADDP(0.1);
    grd->lat[7] = ADDP(0.2);
    grd->lon[0] = ADDP(0.0);
    grd->lon[1] = ADDP(0.1);
    grd->lon[2] = ADDP(0.1);
    grd->lon[3] = ADDP(0.2);
    grd->lon[4] = ADDP(0.2);
    grd->lon[5] = ADDP(0.3);
    grd->lon[6] = ADDP(0.3);
    grd->lon[7] = ADDP(0.4);
    grd->lon[8] = ADDP(0.4);
    grd->lon[9] = ADDP(0.5);
    grd->r[0]   = shcs_pot->r;
    grd->r[1]   = shcs_pot->r + ADDP(1000.0);
    grd->r[2]   = shcs_pot->r + ADDP(2000.0);
    grd->r[3]   = shcs_pot->r + ADDP(3000.0);


    CHARM(shs_cell)(grd, shcs_pot, nmax_pot, f, err);
    CHARM(err_handler)(err, 1);


    REAL f_grd_symm_cell_ref[20] = {
                           ADDP(3.1678105991429534516075872626879847e+04),
                           ADDP(3.1670068723793057581599039340384284e+04),
                           ADDP(3.1630408541410355774435821958026602e+04),
                           ADDP(3.1557199749937373745750358963126683e+04),
                           ADDP(3.1461446031291369177910457748719643e+04),
                           ADDP(3.3696193667808424102770337795258514e+04),
                           ADDP(3.3662641770605939427402396850629583e+04),
                           ADDP(3.3599917074751530990840198750878980e+04),
                           ADDP(3.3516024461743954350919803237401548e+04),
                           ADDP(3.3425233632580152767609277028888806e+04),
                           ADDP(3.3709671757244119143371390026071062e+04),
                           ADDP(3.3655198633564248448402830445385094e+04),
                           ADDP(3.3578581200396771517264194465180763e+04),
                           ADDP(3.3496801301879369834472730650570603e+04),
                           ADDP(3.3424342606935645178661606184162239e+04),
                           ADDP(3.1712373311361199320093612459528776e+04),
                           ADDP(3.1646500234894689523862933329946273e+04),
                           ADDP(3.1567006184477851752702210077456193e+04),
                           ADDP(3.1496577935599066456650188407496080e+04),
                           ADDP(3.1447383077218335561746963338395247e+04)};


    printf("    SHS with cells and a symmetric grid...\n");
    errnum += cmp_arrays(f, f_grd_symm_cell_ref, grd->nlat * grd->nlon,
                         CHARM(glob_threshold));


    free(f);
    /* --------------------------------------------------------------------- */






    /* Check the synthesis of the block-mean values in cells placed on an
     * irregular surface */
    /* --------------------------------------------------------------------- */
    /* The same grid is used as in the previous example */


    f = (REAL *)malloc(grd->nlat * grd->nlon * sizeof(REAL));
    if (f == NULL)
    {
        fprintf(stderr, "malloc failure.\n");
        exit(CHARM_FAILURE);
    }


    REAL topo_cnm00 = shcs_topo->c[0][0];
    REAL pot_cnm00  = shcs_pot->c[0][0];
    shcs_topo->c[0][0] += ADDP(6378136.3);
    shcs_pot->c[0][0]   = ADDP(0.0);
    CHARM(shs_cell_isurf)(grd, shcs_pot, nmax_pot, shcs_topo, nmax_topo,
                          15, 15, f, err);
    shcs_topo->c[0][0] = topo_cnm00;
    shcs_pot->c[0][0]  = pot_cnm00;
    CHARM(err_handler)(err, 1);


    REAL f_grd_cell_grd_isurf_ref[20] = {
                            ADDP(3.1693026317164029149859517618101020e+04),
                            ADDP(3.1678862891256554607465777732797720e+04),
                            ADDP(3.1634289822992274198013184863016668e+04),
                            ADDP(3.1558106138907615522148430535595362e+04),
                            ADDP(3.1461760371173108961390395601187670e+04),
                            ADDP(3.3721760954927314656715931758054930e+04),
                            ADDP(3.3681136136894654983736174654439836e+04),
                            ADDP(3.3612837984519067453293455323112273e+04),
                            ADDP(3.3525628187993348580945344695680372e+04),
                            ADDP(3.3434218319168390957027855104312514e+04),
                            ADDP(3.3746422667699243939240282936448228e+04),
                            ADDP(3.3684418805302096895003377818225861e+04),
                            ADDP(3.3601908061359449540094079389861634e+04),
                            ADDP(3.3516608653326985314870946631946597e+04),
                            ADDP(3.3443410593110192267432021158377948e+04),
                            ADDP(3.1759277326294320931325705429100599e+04),
                            ADDP(3.1686020796389453818414893126621323e+04),
                            ADDP(3.1600733079134690097012214786570432e+04),
                            ADDP(3.1526775654662885693545885978983496e+04),
                            ADDP(3.1476660217345741194686117081954552e+04)};


    printf("    SHS with cells residing on an irregular surface...\n");
    errnum += cmp_arrays(f, f_grd_cell_grd_isurf_ref, grd->nlat * grd->nlon,
                         ADDP(10.0) * CHARM(glob_threshold));


    free(f);
    /* --------------------------------------------------------------------- */






    /* Check non-symmetric grid cells */
    /* --------------------------------------------------------------------- */
    f = (REAL *)malloc(grd->nlat * grd->nlon * sizeof(REAL));
    if (f == NULL)
    {
        fprintf(stderr, "malloc failure.\n");
        exit(CHARM_FAILURE);
    }


    /* The same grid of cells is used as in the previous two examples.  We just
     * modify the maximum latitude of one cell row, so that the grid becomes
     * non-symmetric. */
    grd->lat[1] = ADDP(-0.11);


    CHARM(shs_cell)(grd, shcs_pot, nmax_pot, f, err);
    CHARM(err_handler)(err, 1);


    REAL f_grd_nonsymm_cell_ref[20] = {
                            ADDP(3.1539483884304162344612853262249604e+04),
                            ADDP(3.1532751800339675137457710293681005e+04),
                            ADDP(3.1494381565671056503825447580346986e+04),
                            ADDP(3.1421956650871632782367486224379194e+04),
                            ADDP(3.1326260578009571540778148481955595e+04),
                            ADDP(3.3696193667808424102770337795258514e+04),
                            ADDP(3.3662641770605939427402396850629583e+04),
                            ADDP(3.3599917074751530990840198750878980e+04),
                            ADDP(3.3516024461743954350919803237401548e+04),
                            ADDP(3.3425233632580152767609277028888806e+04),
                            ADDP(3.3709671757244119143371390026071062e+04),
                            ADDP(3.3655198633564248448402830445385094e+04),
                            ADDP(3.3578581200396771517264194465180763e+04),
                            ADDP(3.3496801301879369834472730650570603e+04),
                            ADDP(3.3424342606935645178661606184162239e+04),
                            ADDP(3.1712373311361199320093612459528776e+04),
                            ADDP(3.1646500234894689523862933329946273e+04),
                            ADDP(3.1567006184477851752702210077456193e+04),
                            ADDP(3.1496577935599066456650188407496080e+04),
                            ADDP(3.1447383077218335561746963338395247e+04)};


    printf("    SHS with cells and a non-symmetric grid...\n");
    errnum += cmp_arrays(f, f_grd_nonsymm_cell_ref,
                         grd->nlat * grd->nlon, CHARM(glob_threshold));


    CHARM(crd_free)(grd);
    free(f);
    /* --------------------------------------------------------------------- */






    /* Check grid cells with FFT */
    /* --------------------------------------------------------------------- */
    grd = CHARM(crd_init)(CHARM_CRD_CELLS_GRID, 4, 30);
    if (grd == NULL)
    {
        fprintf(stderr, "Failed to initialize the grid cells.\n");
        exit(CHARM_FAILURE);
    }


    /* Define grid cells */
    REAL delta_r = ADDP(1000.0);
    for (size_t i = 0; i < grd->nlat; i++)
    {
        grd->lat[2 * i]      = -PI_2 + (REAL)i       * PI / grd->nlat;
        grd->lat[2 * i + 1]  = -PI_2 + (REAL)(i + 1) * PI / grd->nlat;
        grd->r[i] = shcs_pot->r + delta_r;
    }
    for (size_t j = 0; j < grd->nlon; j++)
    {
        grd->lon[2 * j]      = (REAL)j       * (ADDP(2.0) * PI) / grd->nlon;
        grd->lon[2 * j + 1]  = (REAL)(j + 1) * (ADDP(2.0) * PI) / grd->nlon;
    }


    f = (REAL *)malloc(grd->nlat * grd->nlon * sizeof(REAL));
    if (f == NULL)
    {
        fprintf(stderr, "malloc failure.\n");
        exit(CHARM_FAILURE);
    }


    CHARM(shs_cell)(grd, shcs_pot, nmax_pot, f, err);
    CHARM(err_handler)(err, 1);


    REAL f_grd_cell_fft_ref[120] = {
                        ADDP(-4.06345921873695228150900747852329130e+04),
                        ADDP(-4.05913676217812317089487648656254091e+04),
                        ADDP(-4.05303031713749549470778406686492945e+04),
                        ADDP(-4.04860989686481266929531429743639557e+04),
                        ADDP(-4.04816499701226188727456195168371952e+04),
                        ADDP(-4.05238099303793107777552373579981984e+04),
                        ADDP(-4.06131677391006109516620888521425172e+04),
                        ADDP(-4.07408799071128440212856234547773149e+04),
                        ADDP(-4.08813913349661312827334994523148308e+04),
                        ADDP(-4.09992699651401174612231611834660695e+04),
                        ADDP(-4.10710508038701420245588815916161489e+04),
                        ADDP(-4.11005596947649458806176732327973640e+04),
                        ADDP(-4.11096085752079527903856882711404967e+04),
                        ADDP(-4.11196158569495867923840670235460908e+04),
                        ADDP(-4.11406610012234667197669671641757759e+04),
                        ADDP(-4.11623138208550852281661520750108335e+04),
                        ADDP(-4.11601703237538611515515575372554640e+04),
                        ADDP(-4.11276563131264675696327307827345652e+04),
                        ADDP(-4.10867885036959641429695233684812638e+04),
                        ADDP(-4.10552991790510092243810146959504116e+04),
                        ADDP(-4.10235352049669681748984929987138376e+04),
                        ADDP(-4.09705547093816709942375378578738243e+04),
                        ADDP(-4.08906109476121174288936591691017797e+04),
                        ADDP(-4.08070660678264191875694401156914038e+04),
                        ADDP(-4.07559906500382603867917767075625687e+04),
                        ADDP(-4.07416600923628453050728765049889218e+04),
                        ADDP(-4.07280548537346027194304477924287259e+04),
                        ADDP(-4.06935781553483399721082680777804921e+04),
                        ADDP(-4.06607360083473956981055445147889646e+04),
                        ADDP(-4.06485809926565692903259721878369153e+04),
                        ADDP( 1.70972209957592429651078967751599458e+04),
                        ADDP( 1.70859521650799774879756021996729254e+04),
                        ADDP( 1.69920986959125414524202564767847213e+04),
                        ADDP( 1.68918582351672126218710146127611235e+04),
                        ADDP( 1.68366566281984649794816931502858012e+04),
                        ADDP( 1.67288773444987262272565694454673827e+04),
                        ADDP( 1.65598105552339829008192454342006035e+04),
                        ADDP( 1.65174071589317870763555381691689604e+04),
                        ADDP( 1.66550635507349021884314102860163362e+04),
                        ADDP( 1.68412347949919901854656979884579592e+04),
                        ADDP( 1.70379573493354460703548166294034111e+04),
                        ADDP( 1.72281922595159888037534021517039370e+04),
                        ADDP( 1.73259974706306783930866527340211919e+04),
                        ADDP( 1.73421029416672892414570130702691264e+04),
                        ADDP( 1.72992553199209022827144584053397095e+04),
                        ADDP( 1.71602386403489138635425282597217620e+04),
                        ADDP( 1.70034313976511565204834401317142303e+04),
                        ADDP( 1.69066242246613477593126355593762215e+04),
                        ADDP( 1.68269525161802612538404254806372028e+04),
                        ADDP( 1.67937666784882009449568818468645498e+04),
                        ADDP( 1.68226475961144107006192244118287888e+04),
                        ADDP( 1.68251238321321758599702102270025500e+04),
                        ADDP( 1.68769102877443086996532971084769403e+04),
                        ADDP( 1.70477915879202091408984296821493825e+04),
                        ADDP( 1.70940982078906596275329925062596477e+04),
                        ADDP( 1.69124728703872438552217304293876328e+04),
                        ADDP( 1.67957378521041092545802298457154654e+04),
                        ADDP( 1.68865887463459280914956681962597947e+04),
                        ADDP( 1.70075846649807520375254211872044876e+04),
                        ADDP( 1.70631916082548281671185387247851911e+04),
                        ADDP( 1.71890053724512210816975927405964515e+04),
                        ADDP( 1.70809109459566187452324111920887746e+04),
                        ADDP( 1.69977802310856916225845687569016958e+04),
                        ADDP( 1.68637318488888007850112378288293203e+04),
                        ADDP( 1.66163595919112817718424759832414706e+04),
                        ADDP( 1.63693235349927551078695714375244603e+04),
                        ADDP( 1.62571484376230851696197045211011525e+04),
                        ADDP( 1.63480520619491167763335383320430765e+04),
                        ADDP( 1.66284329276580301741145251933179038e+04),
                        ADDP( 1.69793215876901733161417666182016452e+04),
                        ADDP( 1.72607118488600866975486930711937511e+04),
                        ADDP( 1.73625152070335983433297505113597565e+04),
                        ADDP( 1.72544817621567137032425131726002267e+04),
                        ADDP( 1.70696453117602198686076016456490269e+04),
                        ADDP( 1.69610772404986487524414958771414082e+04),
                        ADDP( 1.69363389565386036438712327472400389e+04),
                        ADDP( 1.69271508508394945077126975455028370e+04),
                        ADDP( 1.68489007272021937127017070818134747e+04),
                        ADDP( 1.66809186980943484749466023813552739e+04),
                        ADDP( 1.65625891023828401025455037694257028e+04),
                        ADDP( 1.66001423247614244117377513059441204e+04),
                        ADDP( 1.67115039971179142375436138861229530e+04),
                        ADDP( 1.67752229961158640207853696963184930e+04),
                        ADDP( 1.67155601765989952563015453346157839e+04),
                        ADDP( 1.65844138609641805221683182748527370e+04),
                        ADDP( 1.66121221261124650932897914803539463e+04),
                        ADDP( 1.68640052043235185894694375385818142e+04),
                        ADDP( 1.71060706042128238341450234480456076e+04),
                        ADDP( 1.72152884376334583352226246110946260e+04),
                        ADDP( 1.72455535965399290122100753564303610e+04),
                        ADDP(-4.03935664949785919754700866879834991e+04),
                        ADDP(-4.04841263549649244830166643707888868e+04),
                        ADDP(-4.05753606336021859505881672601109004e+04),
                        ADDP(-4.06897723558028661703354657356915402e+04),
                        ADDP(-4.08271622019086708453510247291572686e+04),
                        ADDP(-4.09599103903131295470488448042709483e+04),
                        ADDP(-4.10619613668828398684097412259544428e+04),
                        ADDP(-4.11096375206441581665235524929012652e+04),
                        ADDP(-4.10712294453903920629639915553006068e+04),
                        ADDP(-4.09439218867514526528056871273295282e+04),
                        ADDP(-4.07917765595926048069899202238614817e+04),
                        ADDP(-4.07021618239802007843537768142929029e+04),
                        ADDP(-4.07014722466986919831429031227383954e+04),
                        ADDP(-4.07401889668693034424612817439927270e+04),
                        ADDP(-4.07596775714410692680357551084920915e+04),
                        ADDP(-4.07507851307382649278499757124383741e+04),
                        ADDP(-4.07457871983032589261445563832220625e+04),
                        ADDP(-4.07735177676994141672468446714750765e+04),
                        ADDP(-4.08330791680083449988677097702334576e+04),
                        ADDP(-4.09053306546395943458464643823350595e+04),
                        ADDP(-4.09778158450359137032114437103586840e+04),
                        ADDP(-4.10458601733681316547392549153108270e+04),
                        ADDP(-4.10868570816672552194493597714807806e+04),
                        ADDP(-4.10492386017829964848716569531519785e+04),
                        ADDP(-4.08909915173791142964026929849117200e+04),
                        ADDP(-4.06392289187305282205565789053498686e+04),
                        ADDP(-4.03935699082166525473988238435347002e+04),
                        ADDP(-4.02504353689060931422693365870563924e+04),
                        ADDP(-4.02328276883720940062936455879915613e+04),
                        ADDP(-4.02990190122866222687944367489462963e+04)
                                    };


    printf("    SHS with grid cells and FFT...\n");
    errnum += cmp_arrays(f, f_grd_cell_fft_ref,
                         grd->nlat * grd->nlon, CHARM(glob_threshold));


    CHARM(crd_free)(grd);
    free(f);
    /* --------------------------------------------------------------------- */






    /* --------------------------------------------------------------------- */
    CHARM(shc_free)(shcs_pot);
    CHARM(shc_free)(shcs_topo);
    CHARM(err_free)(err);


    return errnum;
    /* --------------------------------------------------------------------- */
}
/* ------------------------------------------------------------------------- */

